<!DOCTYPE html>
<html>
  <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Traffic Violation Detection (Horizontal Separator)</title>
        <style>
          body { font-family: Arial, Helvetica, sans-serif; color: #000000; padding: auto; } h1{ color: #161616; } .container{ margin: auto; width: 90%; height: 90%; background-color: #fff; top: 0; left: 0; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; } p{ margin: 0; } .black-text{ color: #161616; } .row{ display: flex; flex-direction: row; } .mb-3{ margin-bottom: 2rem; } h2 { font-size: 18px; } td{ margin : 0.25rem; } section.main { display: flex; align-items: center; } #menu, section.main { flex-direction: column; } #menu { text-align: left; display: none; flex-wrap: nowrap; min-width: 340px; background: #e2e2e2; border: 1px solid #f21c21; padding: 8px; border-radius: 4px; margin-top: -10px; margin-right: 10px; } #content { display: flex; flex-wrap: wrap; align-items: stretch; } figure { padding: 0; margin: 0; -webkit-margin-before: 0; margin-block-start: 0; -webkit-margin-after: 0; margin-block-end: 0; -webkit-margin-start: 0; margin-inline-start: 0; -webkit-margin-end: 0; margin-inline-end: 0; } figure img { display: block; width: 100%; height: auto; border-radius: 4px; margin-top: 8px; } @media (min-width: 800px) and (orientation: landscape) { #content { display: flex; flex-wrap: nowrap; align-items: stretch; } figure img { display: block; max-width: 100%; max-height: calc(100vh - 40px); width: auto; height: auto; } figure { padding: 0; margin: 0; -webkit-margin-before: 0; margin-block-start: 0; -webkit-margin-after: 0; margin-block-end: 0; -webkit-margin-start: 0; margin-inline-start: 0; -webkit-margin-end: 0; margin-inline-end: 0; } } section#buttons { display: flex; flex-wrap: nowrap;; align-items:center; text-align: center; padding: auto; } #nav-toggle { cursor: pointer; display: block; } #nav-toggle-cb { text-align: left; outline: 0; opacity: 0; width: 0; height: 0; } #nav-toggle-cb:checked + #menu { display: flex; } .input-group { display: flex; flex-wrap: nowrap; line-height: 22px; margin: 5px 0; } .input-group > label { display: inline-block; padding-right: 10px; min-width: 47%; } .input-group input, .input-group select { flex-grow: 1; } .range-max, .range-min { display: inline-block; padding: 0 5px; } button { display: block; margin: 5px; padding: 0 12px; border: 0; line-height: 28px; cursor: pointer; color: #fff; background: #ff3034; border-radius: 5px; font-size: 16px; outline: 0; } button:hover { background: #ff494d; } button:active { background: #f21c21; } button.disabled { cursor: default; background: #a0a0a0; } input[type="range"] { -webkit-appearance: none; width: 100%; height: 22px; background: #e2e2e2; cursor: pointer; margin: 0; } input[type="range"]:focus { outline: 0; } input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 2px; cursor: pointer; background: #efefef; border-radius: 0; border: 0 solid #efefef; } input[type="range"]::-webkit-slider-thumb { border: 1px solid rgba(0, 0, 30, 0); height: 22px; width: 22px; border-radius: 50px; background: #ff3034; cursor: pointer; -webkit-appearance: none; margin-top: -11.5px; } input[type="range"]:focus::-webkit-slider-runnable-track { background: #efefef; } input[type="range"]::-moz-range-track { width: 100%; height: 2px; cursor: pointer; background: #efefef; border-radius: 0; border: 0 solid #efefef; } input[type="range"]::-moz-range-thumb { border: 1px solid rgba(0, 0, 30, 0); height: 22px; width: 22px; border-radius: 50px; background: #ff3034; cursor: pointer; } input[type="range"]::-ms-track { width: 100%; height: 2px; cursor: pointer; background: 0 0; border-color: transparent; color: transparent; } input[type="range"]::-ms-fill-lower { background: #efefef; border: 0 solid #efefef; border-radius: 0; } input[type="range"]::-ms-fill-upper { background: #efefef; border: 0 solid #efefef; border-radius: 0; } input[type="range"]::-ms-thumb { border: 1px solid rgba(0, 0, 30, 0); height: 22px; width: 22px; border-radius: 50px; background: #ff3034; cursor: pointer; height: 2px; } input[type="range"]:focus::-ms-fill-lower { background: #efefef; } input[type="range"]:focus::-ms-fill-upper { background: #363636; } .switch { display: block; position: relative; line-height: 22px; font-size: 16px; height: 22px; } .switch input { outline: 0; opacity: 0; width: 0; height: 0; } .slider { width: 50px; height: 22px; border-radius: 22px; cursor: pointer; background-color: grey; } .slider, .slider:before { display: inline-block; transition: 0.4s; } .slider:before { position: relative; content: ""; border-radius: 50%; height: 16px; width: 16px; left: 4px; top: 3px; background-color: #fff; } input:checked + .slider { background-color: #ff3034; } input:checked + .slider:before { -webkit-transform: translateX(26px); transform: translateX(26px); } select { border: 1px solid #363636; font-size: 14px; height: 22px; outline: 0; border-radius: 5px; } .image-container { position: relative; min-width: 160px; } .close { position: absolute; right: -20px; top: 5px; background: #ff3034; width: 16px; height: 16px; border-radius: 100px; color: #fff; text-align: center; line-height: 18px; cursor: pointer; } .hidden { display: none; }
        </style>
        <script src="https:\/\/ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
        <script src="https:\/\/cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"> </script>
        <script src="https:\/\/cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"> </script>       
    </head>
    <body>
      <div class="container">
        <h1>Traffic Violation Detection (Horizontal Separator)</h1>
        <p class="black-text">
          ESP32-CAM IP Address
        </p>
        <div class="row mb-3">
          <input type="text" id="ip" size="14" value="192.168." disabled>&nbsp;&nbsp;<input type="button" value="Reset" onclick="start();">
        </div>
      
    <figure>
      <div id="stream-container" class="image-container hidden">
        <div class="close" id="close-stream">×</div>
        <img id="stream" src="" crossorigin="anonymous" style="background-color:#000000;display:none;">
        <table>
          <tr>
          <td align="left"><input type="range" id="lefttop" min="0" max="100" value="25" step="1" required></td>
          <td align="right"><input type="range" id="righttop" min="0" max="100" value="75" step="1" required></td>
          </tr>
          <tr>
          <td colspan="2"><canvas id="canvas" style="background-color: #000000;"></canvas></td>
          </tr>
          <tr>
          <td align="left"><input type="range" id="leftbottom" min="0" max="100" value="25" step="1" required></td>
          <td align="right"><input type="range" id="rightbottom" min="0" max="100" value="75" step="1" required></td>
          </tr>
        </table>
      </div>
      </figure>
        <section class="main">
            <section id="buttons">
                <table>
                <tr><td><button id="restartButton">Restart</button></td><td><button id="toggle-stream" style="display:none">Start Camera</button></td><td align="right"><button id="face_enroll" style="display:none" class="disabled" disabled="disabled"></button><button id="get-still" style="display:none;">Start Camera</button></td></tr>
                <tr>
                  <td colspan="3">
                    <table>
                      <tbody>
                      <tr> 
                        <td align="left">
                          Object
                            <select id="object" onchange="count.innerHTML='';">
                              <option value="person" selected="selected">person</option>
                              <option value="bicycle">bicycle</option>
                              <option value="car">car</option>
                              <option value="motorcycle">motorcycle</option>
                              <option value="airplane">airplane</option>
                              <option value="bus">bus</option>
                              <option value="train">train</option>
                              <option value="truck">truck</option>
                            </select>
                            <span id="count" style="color:red">0</span>
                        </td>          
                        <td align="right">
                          Marker
                          <select id="mark">
                          <option value="center">Center</option>               
                          <option value="upper">Upper</option>
                          <option value="lower" selected="selected">Lower</option>
                          <option value="left">Left</option>
                          <option value="right">Right</option>
                          </select>
                            
                        </td>   
                      </tr>
                      <tr> 
                        <td align="left">
                          Score Treshold
                          <select id="score">
                          <option value="1.0">1</option>
                          <option value="0.9">0.9</option>
                          <option value="0.8">0.8</option>
                          <option value="0.7">0.7</option>
                          <option value="0.6">0.6</option>
                          <option value="0.5" selected="selected">0.5</option>
                          <option value="0.4">0.4</option>
                          <option value="0.3">0.3</option>
                          <option value="0.2">0.2</option>
                          <option value="0.1">0.1</option>
                          <option value="0">0</option>
                          </select>
                        </td>
                        <td align="right">
                        <input id="complementary" type="checkbox">Complementary Area
                        </td>           
                      </tr>          
                      <tr>
                        <td align="left">
                          <input type="checkbox" id="chkAud">Alarm (mp3 files)</td>
                        <td align="right">
                          <input style="height: 100%;" type="text" id="aud" size="20" value="https:\/\/raw.githubusercontent.com/gremlinflat/ESP32-CAM---Smart-Traffic-Violation-System/master/%5Bfrondend%5D_web/mixkit-facility-alarm-908.mp3">
                        </td>
                      </tr> 
                      <tr>
                        <td align="left" colspan="3">
                          <input type="checkbox" id="chkBuzzer">Buzzer (GPIO 2)
                        </td>
                      </tr>
                      <tr><td align="left" colspan="3"><span id="message" style="display:none"></span></td></tr> 
                    </tbody></table> 
                  </td>
                </tr>                
                </tbody></table>
            </section>         
            <div id="logo">
                <label for="nav-toggle-cb" id="nav-toggle">☰&nbsp;&nbsp;Settings</label>
            </div>
            <div id="content">
                <div id="sidebar">
                    <input type="checkbox" id="nav-toggle-cb">
                    <nav id="menu">
                        <div class="input-group" id="flash-group">
                            <label for="flash">Flash</label>
                            <div class="range-min">0</div>
                            <input type="range" id="flash" min="0" max="255" value="0" class="default-action">
                            <div class="range-max">255</div>
                        </div>
                        <div class="input-group" id="framesize-group">
                            <label for="framesize">Frame Size</label>
                            <select id="framesize" class="default-action">
                                <option value="10">UXGA(1600x1200)</option>
                                <option value="9">SXGA(1280x1024)</option>
                                <option value="8">XGA(1024x768)</option>
                                <option value="7">SVGA(800x600)</option>
                                <option value="6">VGA(640x480)</option>
                                <option value="5">CIF(400x296)</option>
                                <option value="4" selected="selected">QVGA(320x240)</option>
                                <option value="3">HQVGA(240x176)</option>
                                <option value="0">QQVGA(160x120)</option>
                            </select>
                        </div>
                        <div class="input-group" id="quality-group">
                            <label for="quality">Quality</label>
                            <div class="range-min">10</div>
                            <input type="range" id="quality" min="10" max="63" value="10" class="default-action">
                            <div class="range-max">63</div>
                        </div>
                        <div class="input-group" id="brightness-group">
                            <label for="brightness">Brightness</label>
                            <div class="range-min">-2</div>
                            <input type="range" id="brightness" min="-2" max="2" value="0" class="default-action">
                            <div class="range-max">2</div>
                        </div>
                        <div class="input-group" id="contrast-group">
                            <label for="contrast">Contrast</label>
                            <div class="range-min">-2</div>
                            <input type="range" id="contrast" min="-2" max="2" value="0" class="default-action">
                            <div class="range-max">2</div>
                        </div>
                        <div class="input-group" id="hmirror-group">
                            <label for="hmirror">Hmirror</label>
                            <div class="switch">
                                <input id="hmirror" type="checkbox" class="default-action" checked>
                                <label class="slider" for="hmirror"></label>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>
        </section>
        <iframe id="ifr" style="display:none;position:absolute" src=""></iframe>
        <div id="position" style="display:none;color:blue;font-size:40px"></div>
        <div id="result" style="color:red">Waiting fot loading model...</div> 
    
        <div style="display:none">
        <form id="myForm" action="https:\/\/script.google.com/macros/s/AKfycbyp1xvWg-UCSrLsL8zt-ba_0n96uNTpAFyRry9ifCnRbtK-vgg/exec" method="post" target="sendcapturedimage">
        <input type="text" id="myFilename" name="myFilename" value="Caution Area" style="display:none">
        <input type="text" id="myToken" name="myToken" value="" style="display:none">
        <textarea id="myFile" name="myFile" rows="10" cols="50" style="display:none"></textarea><br>
        </form>
        <iframe id="sendcapturedimage" name="sendcapturedimage" style="display:none"></iframe>
        </div>
      </div>
        <script>
        function start() {
            var baseHost = 'http:\/\/'+document.getElementById("ip").value;  //var baseHost = document.location.origin
            var streamUrl = baseHost + ':81';
            const hide = el => {
              el.classList.add('hidden')
            }
            const show = el => {
              el.classList.remove('hidden')
            }
            const disable = el => {
              el.classList.add('disabled')
              el.disabled = true
            }
            const enable = el => {
              el.classList.remove('disabled')
              el.disabled = false
            }
            const updateValue = (el, value, updateRemote) => {
              updateRemote = updateRemote == null ? true : updateRemote
              let initialValue
              if (el.type === 'checkbox') {
                initialValue = el.checked
                value = !!value
                el.checked = value
              } else {
                initialValue = el.value
                el.value = value
              }
              if (updateRemote && initialValue !== value) {
                updateConfig(el);
              } 
            }
            function updateConfig (el) {
              let value
              switch (el.type) {
                case 'checkbox':
                  value = el.checked ? 1 : 0
                  break
                case 'range':
                case 'select-one':
                  value = el.value
                  break
                case 'button':
                case 'submit':
                  value = '1'
                  break
                default:
                  return
              }
              const query = `${baseHost}/control?var=${el.id}&val=${value}`
              fetch(query)
                .then(response => {
                  console.log(`request to ${query} finished, status: ${response.status}`)
                })
            }
            document
              .querySelectorAll('.close')
              .forEach(el => {
                el.onclick = () => {
                  hide(el.parentNode)
                }
              })
            // read initial values
      
            fetch(`${baseHost}/status`)
              .then(function (response) {
                return response.json()
              })
              .then(function (state) {
                document
                  .querySelectorAll('.default-action')
                  .forEach(el => {
                    updateValue(el, state[el.id], false)
                  })
              })
      
            const view = document.getElementById('stream')
            const viewContainer = document.getElementById('stream-container')
            const restartButton = document.getElementById('restartButton')
            const stillButton = document.getElementById('get-still')
            const streamButton = document.getElementById('toggle-stream')
            const closeButton = document.getElementById('close-stream')
            const stopStream = () => {
              //window.stop();
              streamButton.innerHTML = 'Start Stream'
            }
            const startStream = () => {
              view.src = `${streamUrl}/stream`
              show(viewContainer)
              streamButton.innerHTML = 'Stop Stream'
            }
            
            restartButton.onclick = () => {
              fetch(baseHost+"/control?restart");
            } 
                        
            // Attach actions to buttons
            stillButton.onclick = () => {
              stopStream()
        
              baseHost = "http:\/\/"+ip.value;
              streamUrl = baseHost + ':81';
              result.innerHTML = "";
              canvas.style.display = "block"; 
        
              try{
                view.src = `${baseHost}/capture?_cb=${Date.now()}`
              }
              catch(e) {
                view.src = `${baseHost}/capture?_cb=${Date.now()}`  
              }
              show(viewContainer)
            }
            closeButton.onclick = () => {
              stopStream()
              hide(viewContainer)
            }
            streamButton.onclick = () => {
              const streamEnabled = streamButton.innerHTML === 'Stop Stream'
              if (streamEnabled) {
                stopStream()
              } else {
                startStream()
              }
            }
            // Attach default on change action
            document
              .querySelectorAll('.default-action')
              .forEach(el => {
                el.onchange = () => updateConfig(el)
              })
          }
        </script>
        <script>
          var ip = document.getElementById('ip');
          var link = document.getElementById('link');
          var canvas = document.getElementById('canvas');
          var context = canvas.getContext("2d"); 
          var ShowImage = document.getElementById('stream');
          var example = document.getElementById('example');
          var result = document.getElementById('result');
          var count = document.getElementById('count');
          var score = document.getElementById('score');
          var complementary = document.getElementById('complementary');
          var getStill = document.getElementById('get-still');
          var hmirror = document.getElementById('hmirror'); 
          var ifr = document.getElementById('ifr');
      
          var lefttop = document.getElementById('lefttop');
          var righttop = document.getElementById('righttop');
          var leftbuttom = document.getElementById('leftbottom');
          var rightbuttom = document.getElementById('rightbottom');
          var token = document.getElementById('token');         
          var aud = document.getElementById('aud');
          var chkAud = document.getElementById('chkAud');
          var chkLine = document.getElementById('chkLine');
          var chkBuzzer = document.getElementById('chkBuzzer');
          var alarm = new Audio(aud.value);
          var position = document.getElementById('position'); 
          var mark = document.getElementById('mark');
      
          var Model;
                    
          function loadModel() {
            cocoSsd.load().then(cocoSsd_Model => {
              Model = cocoSsd_Model;
              getStill.style.display = "block";
              result.innerHTML = "";
            }); 
          }
          
          ShowImage.onload = function (event) {
            if (Model) {
              try { 
                document.createEvent("TouchEvent");
                DetectImage();
              }
              catch(e) { 
                DetectImage();
              }   
            }     
          }
     
          function DetectImage() {
            canvas.setAttribute("width", ShowImage.width);
            canvas.setAttribute("height", ShowImage.height);
            context.drawImage(ShowImage,0,0,ShowImage.width,ShowImage.height); 
                       
            Model.detect(canvas).then(Predictions => {    
              var objectCount=0; 
              context.strokeStyle = 'yellow';
              context.lineWidth = 5;    
              context.beginPath();
              context.moveTo(0, lefttop.value*ShowImage.height/100);
              context.lineTo(ShowImage.width, righttop.value*ShowImage.height/100);
              context.stroke();
              context.beginPath();
              context.moveTo(0, leftbottom.value*ShowImage.height/100);
              context.lineTo(ShowImage.width, rightbottom.value*ShowImage.height/100);
              context.stroke(); 
    
              //console.log('Predictions: ', Predictions);
              if (Predictions.length>0) {
                result.innerHTML = "";
                var s = (canvas.width>canvas.height)?canvas.width:canvas.height;
                for (var i=0;i<Predictions.length;i++) {
                  const x = Predictions[i].bbox[0];
                  const y = Predictions[i].bbox[1];         
                  const width = Predictions[i].bbox[2];
                  const height = Predictions[i].bbox[3];
                  var mark_x = 0;
                  var mark_y = 0;
                  if (mark.value=="upper") {
                  mark_x = x + width/2;
                  mark_y = y;
                  } 
                  else if (mark.value=="lower") {
                  mark_x = x + width/2;
                  mark_y = y + height;
                  }
                  else if (mark.value=="left") {
                  mark_x = x;
                  mark_y = y + height/2;
                  }
                  else if (mark.value=="right") {
                  mark_x = x + width;
                  mark_y = y + height/2;
                  }
                  else if (mark.value=="center") {
                  mark_x = x + width/2;
                  mark_y = y + height/2;
                  } 
          
                  result.innerHTML+= "[ "+i+" ] "+Predictions[i].class+", "+Math.round(Predictions[i].score*100)+"%, "+Math.round(x)+", "+Math.round(y)+", "+Math.round(width)+", "+Math.round(height)+"<br>";
                  if (Predictions[i].class==object.value&&Predictions[i].score>=score.value) {   
                    context.fillStyle="#00FFFF";        
                    context.beginPath();
                    context.arc(mark_x, mark_y, 5, 0, Math.PI*2, true);
                    context.fill();
                    context.closePath();
                    
                    var lt = Number(lefttop.value*ShowImage.height/100)+0.1;
                    var rt = Number(righttop.value*ShowImage.height/100);
                    var lb = Number(leftbottom.value*ShowImage.height/100)+0.1;
                    var rb = Number(rightbottom.value*ShowImage.height/100);
                    
                    var p1,p2;
                    var tx1 =  (0 - ShowImage.width) / (lt - rt) * (mark_y - rt) + ShowImage.width;
                    if (tx1>mark_x) {
                      p1 = 1;
                    }
                    else {
                      p1 = 0;
                    }
                    
                    var tx2 =  (0 - ShowImage.width) / (lb - rb) * (mark_y - rb) + ShowImage.width;
                    if (tx2>mark_x) {
                      p2 = 1;
                    }
                    else {
                      p2 = 0;
                    }   
            
                    if ((lt>rt)&&(lb>rb)) {
                      if (p1==1)
                        position.innerHTML = "1";
                      else if (p1==0&&p2==1)
                        position.innerHTML = "2";
                      else if (p2==0)
                        position.innerHTML = "3"; 
                    } else if ((lt<rt)&&(lb<rb)) {
                      if (p1==0)
                        position.innerHTML = "1";
                      else if (p1==1&&p2==0)
                        position.innerHTML = "2";
                      else if (p2==1)
                        position.innerHTML = "3";
                    }  else if ((lt>rt)&&(lb<rb)) {
                      if (p1==1)
                        position.innerHTML = "1";
                      else if (p1==0&&p2==0)
                        position.innerHTML = "2";
                      else if (p2==1)
                        position.innerHTML = "3";
                    }  else if ((lt<rt)&&(lb>rb)) {
                      if (p1==0)
                        position.innerHTML = "1";
                      else if (p1==1&&p2==1)
                        position.innerHTML = "2";
                      else if (p2==0)
                        position.innerHTML = "3";
                    }
                    
                    var state = false;
                    if (position.innerHTML == "2"&&!complementary.checked&&(alarm.paused||alarm.ended)) {       
                      state=true;
                    }
                    else if (position.innerHTML != "2"&&complementary.checked&&(alarm.paused||alarm.ended)) {       
                      state=true;
                    }
          
                    if (state==true) {
                      if (chkAud.checked) {
                        alarm.src = aud.value;
                        alarm.play();
                      }
                      if (chkLine.checked)
                        ifr.src = 'http:\/\/linenotify.com/notify.php?token='+token.value+'&message=Alarm';                      
                      if (chkBuzzer.checked)
                        $.ajax({url: baseHost+'/control?buzzer='+position.innerHTML, async: false}); 
                      }
                  }
                            
                  if (Predictions[i].class==object.value) {
                    objectCount++;
                  }  
                }
                count.innerHTML = objectCount;
              }
              else {
                position.innerHTML = "";                
                result.innerHTML = "Unrecognizable";
                count.innerHTML = "0";
              }
              
              try { 
                document.createEvent("TouchEvent");
                setTimeout(function(){getStill.click();},250);
              }
              catch(e) { 
                setTimeout(function(){getStill.click();},150);
              } 
            });
          }
      
        function SendCapturedImage() {
          //var date = new Date();
          //myFilename.value = date.getFullYear()+"_"+(date.getMonth()+1)+"_"+date.getDate()+"_"+date.getHours()+"_"+date.getMinutes()+"_"+date.getSeconds()+".png";
          myFile.value = canvas.toDataURL();
          myToken.value = token.value;
          myForm.submit();
        } 

        var href=location.href;
        if (href.indexOf("?")!=-1) {
          ip.value = location.search.split("?")[1].replace(/http:\/\//g,"");
          start();
        }
        else if (href.indexOf("http")!=-1) {
          ip.value = location.host;
          start();
        }

        aud.value = aud.value.replace(/\\\//g,"/");
        loadModel();    
        </script>
    </body>
</html>  